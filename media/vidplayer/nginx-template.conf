{#-
vim: filetype=django:
-#}
###############################################################################
# This file managed by Salt, do not edit by hand!!
###############################################################################
{% for name, upstream in salt['pillar.get']('vidplayer:upstreams', {})|dictsort %}
upstream {{ name }} {
{%- for server in upstream %}
    server {{ server }};
{%- endfor %}
}
{% endfor %}
{% for name, server in salt['pillar.get']('vidplayer:servers', {})|dictsort %}
###############################################################################
# Serve {{ name }}
###############################################################################
server {
    listen          {{ server.get('listen', 80) }};
    server_name     {{ server.get('server_name', 'localhost') }};
    gzip            on;
    gzip_min_length 1000;
    gzip_types      application/javascript;
    access_log      /var/log/nginx/{{ name }}.access_log;
    error_log       /var/log/nginx/{{ name }}.error_log;

    if ($host !~* ^({{ server.get('legal_host_headers') }})$ ) {
        return 444;
    }
{% for location in server.get('locations', []) -%}
{%- for loc_name, contents in location.iteritems() %}
    location {{ loc_name }} {
{%- for line in contents %}
{{ line|indent(8, true) }};
{%- endfor %}
    }
{% endfor -%}
{%- endfor %}
}
{% endfor %}
